{% extends "core/base.html" %}
{% load static %}
{% block title %}Network Map & Discovery{% endblock %}

{% block content %}
<div class="relative overflow-hidden min-h-screen">

    <!-- ===== BACKGROUND IMAGE ===== -->
    <div class="fixed inset-0 -z-50">
        <img src="{% static 'images/world_outline.png' %}" alt="Cyber World Map" class="w-full h-full object-cover">
    </div>

    <!-- ===== CANVAS FOR NODES AND CONNECTIONS ===== -->
    <canvas id="cyberOverlay" class="fixed inset-0 w-full h-full -z-40"></canvas>
    <div class="fixed inset-0 -z-30 bg-black/70"></div>

    <div class="relative z-10 space-y-10 p-6">

        <!-- ===== NETWORK SCAN PANEL ===== -->
        <div class="relative border border-green-600/40 rounded-3xl shadow-xl p-10 bg-black/10 backdrop-blur-md opacity-80">
            <h2 class="text-3xl font-bold text-green-400 mb-3 flex items-center gap-3 tracking-wide">
                üåê Network Map & Discovery
            </h2>
            <p class="text-gray-300 mb-6">Discover and audit all active devices on your network in real-time.</p>

            <form method="post" action="{% url 'start_network_scan' %}" id="scan-button-container" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
                    <div class="md:col-span-2">
                        <label for="ip_range" class="block text-sm font-medium text-gray-300 mb-2">IP Range</label>
                        <input type="text" name="ip_range" id="ip_range" required
                            class="w-full bg-black/80 border border-green-700/70 rounded-xl p-3 text-green-200 placeholder-green-600 
                                   focus:ring-2 focus:ring-green-500 focus:border-green-400 hover:border-green-400/60 
                                   hover:shadow-[0_0_10px_rgba(0,255,100,0.3)] outline-none transition duration-200"
                            placeholder="e.g., 192.168.1.0/24">
                    </div>

                    <div class="md:col-span-2">
                        <label for="interface" class="block text-sm font-medium text-gray-300 mb-2">Network Interface</label>
                        <input type="text" name="interface" id="interface" required
                            class="w-full bg-black/80 border border-green-700/70 rounded-xl p-3 text-green-200 placeholder-green-600 
                                   focus:ring-2 focus:ring-green-500 focus:border-green-400 hover:border-green-400/60 
                                   hover:shadow-[0_0_10px_rgba(0,255,100,0.3)] outline-none transition duration-200"
                            placeholder="e.g., eth0 or wlo1">
                    </div>

                    <div class="md:col-span-1">
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-green-600 via-lime-600 to-green-500 hover:from-green-700 
                                   hover:via-lime-700 hover:to-green-600 text-white font-semibold py-3 px-8 
                                   rounded-xl shadow-lg shadow-green-900/40 transform hover:scale-[1.03] active:scale-95 
                                   transition duration-300 ease-in-out tracking-wide flex items-center justify-center gap-2">
                            üîç <span>Start Scan</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ===== DISCOVERED DEVICES TABLE ===== -->
        <div class="relative bg-black/10 border border-green-700/50 rounded-2xl p-6 shadow-[0_0_25px_rgba(0,255,100,0.2)] backdrop-blur-md opacity-80">
            <h3 class="text-2xl font-bold text-green-400 mb-4">üíª Discovered Devices</h3>
            <div class="overflow-x-auto rounded-xl border border-green-700/40">
                <table class="min-w-full text-sm text-left text-green-200">
                    <thead class="bg-green-900/80 text-green-300 uppercase text-xs tracking-wider">
                        <tr>
                            <th class="p-3">IP Address</th>
                            <th class="p-3">MAC Address</th>
                            <th class="p-3">Hostname</th>
                            <th class="p-3">Vendor</th>
                            <th class="p-3">Last Seen</th>
                            <th class="p-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-green-700/40">
                        {% for device in devices %}
                        <tr class="hover:bg-green-900/20 transition">
                            <td class="p-3 font-mono">
                                <a href="{% url 'scanner' %}?url={{ device.ip_address }}" class="text-green-400 hover:underline">
                                    {{ device.ip_address }}
                                </a>
                            </td>
                            <td class="p-3 font-mono">{{ device.mac_address }}</td>
                            <td class="p-3">{{ device.hostname|default:"-" }}</td>
                            <td class="p-3">{{ device.vendor|default:"-" }}</td>
                            <td class="p-3">{{ device.last_seen|date:"Y-m-d H:i" }}</td>
                            <td class="p-3 text-center">
                                <form method="post" action="{% url 'audit_device' device.id %}">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="bg-gradient-to-r from-green-600 via-lime-600 to-green-500 hover:from-green-700 hover:via-lime-700 hover:to-green-600
                                                   text-white text-xs font-bold py-1.5 px-4 rounded-lg shadow hover:shadow-green-500/30 transition transform hover:scale-[1.05] active:scale-95">
                                        Audit
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center p-6 text-green-500 italic">üö´ No devices discovered yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ===== CYBER NODES ANIMATION OVER IMAGE ===== -->
<canvas id="cyberOverlay" class="fixed inset-0 w-full h-full -z-20"></canvas>

<script>
const canvas = document.getElementById('cyberOverlay');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Config
const numNodes = 50;
const nodes = [];
const connections = [];
const glowColor = '#00ff77';
const pulseSpeed = 0.03;
const flowSpeed = 0.02;

// Helpers
function random(min,max){return Math.random()*(max-min)+min;}
function distance(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}

// Initialize nodes
for(let i=0;i<numNodes;i++){
    nodes.push({
        x: random(canvas.width*0.1, canvas.width*0.9),
        y: random(canvas.height*0.1, canvas.height*0.9),
        radius: random(2,5),
        pulse: Math.random()*Math.PI*2,
        flowProgress: Math.random(),
        highlight: 0
    });
}

// Create random connections
for(let i=0;i<numNodes;i++){
    for(let j=i+1;j<numNodes;j++){
        if(Math.random()<0.15) connections.push([i,j]);
    }
}

// Draw grid lines (subtle)
function drawGrid(){
    const step = 100;
    ctx.strokeStyle = 'rgba(0,255,119,0.03)';
    ctx.lineWidth = 1;
    for(let x=0;x<canvas.width;x+=step){
        ctx.beginPath();
        ctx.moveTo(x,0);
        ctx.lineTo(x,canvas.height);
        ctx.stroke();
    }
    for(let y=0;y<canvas.height;y+=step){
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(canvas.width,y);
        ctx.stroke();
    }
}

// Draw loop
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    drawGrid();

    // Draw connections with flowing pulses
    connections.forEach(conn=>{
        const n1 = nodes[conn[0]], n2 = nodes[conn[1]];

        // line with alpha based on distance from pulse
        ctx.strokeStyle='rgba(0,255,119,0.08)';
        ctx.lineWidth=1;
        ctx.beginPath();
        ctx.moveTo(n1.x,n1.y);
        ctx.lineTo(n2.x,n2.y);
        ctx.stroke();

        // moving pulse
        n1.flowProgress += flowSpeed;
        if(n1.flowProgress > 1) n1.flowProgress = 0;
        const px = n1.x + (n2.x-n1.x)*n1.flowProgress;
        const py = n1.y + (n2.y-n1.y)*n1.flowProgress;

        // highlight nodes when pulse passes
        if(distance({x:px,y:py}, n2)<5) n2.highlight = 1;

        ctx.fillStyle = glowColor;
        ctx.shadowColor = glowColor;
        ctx.shadowBlur = 12;
        ctx.beginPath();
        ctx.arc(px,py,3,0,Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
    });

    // Draw nodes with pulse and highlight
    nodes.forEach(n=>{
        n.pulse += pulseSpeed;
        n.highlight *= 0.9; // fade highlight over time
        const radius = n.radius + Math.sin(n.pulse)*1.5 + n.highlight*3;

        ctx.fillStyle = glowColor;
        ctx.shadowColor = glowColor;
        ctx.shadowBlur = 8 + n.highlight*5;
        ctx.beginPath();
        ctx.arc(n.x,n.y,radius,0,Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
    });

    requestAnimationFrame(draw);
}
draw();

// Resize
window.addEventListener('resize',()=>{
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
</script>

<style>
.severity-low { background-color: #22c55e30; color: #22c55e; border: 1px solid #22c55e80;}
.severity-medium { background-color: #a3e63530; color: #a3e635; border: 1px solid #a3e63580;}
.severity-high { background-color: #84cc16; color: #84cc16; border: 1px solid #84cc1680;}
.severity-critical { background-color: #16a34a30; color: #f87171; border: 1px solid #dc262680;}
</style>

{% endblock %}
