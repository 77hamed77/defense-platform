{% extends "core/base.html" %}
{% load static %}
{% block title %}Network Map & Discovery{% endblock %}

{% block content %}
<div class="space-y-10 animate-fadeIn">

    <!-- ========== ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿπÿßŸÖÿ© ÿßŸÑÿ≤ÿ¨ÿßÿ¨Ÿäÿ© ÿßŸÑŸÖÿ™ÿØÿ±ÿ¨ÿ© ========== -->
    <div class="absolute inset-0 -z-10 bg-gradient-to-br from-gray-900 via-gray-950 to-black">
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(56,189,248,0.15),transparent_70%)]"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(147,51,234,0.15),transparent_70%)]"></div>
    </div>

    <!-- ========== ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ========== -->
    <div class="relative border border-gray-800 rounded-2xl shadow-[0_0_25px_rgba(0,200,255,0.15)] p-8 
                bg-gradient-to-br from-gray-900 via-gray-950 to-black overflow-hidden fade-up">

        <!-- ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ™ŸàŸáÿ¨ ÿßŸÑÿØÿßÿÆŸÑŸä -->
        <div class="absolute inset-0 bg-gradient-to-tr from-cyan-700/10 via-transparent to-transparent blur-2xl"></div>

        <div class="relative z-10">
            <h2 class="text-3xl font-bold text-white mb-3 flex items-center gap-3 tracking-wide">
                <span class="text-cyan-400 drop-shadow-[0_0_6px_rgba(0,200,255,0.7)]">üåê</span>
                Network Map & Discovery
            </h2>
            <div class="w-44 h-1.5 bg-gradient-to-r from-cyan-400 via-blue-500 to-indigo-500 rounded-full mb-8 
                        shadow-[0_0_12px_rgba(0,200,255,0.4)]"></div>

            <p class="text-gray-400 mb-8">Discover and audit all active devices on your network in real-time.</p>

            <form method="post" action="{% url 'start_network_scan' %}" id="scan-button-container" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">
                    <!-- IP Range -->
                    <div class="md:col-span-2">
                        <label for="ip_range" class="block text-sm font-medium text-gray-300 mb-2">IP Range</label>
                        <input type="text" name="ip_range" id="ip_range" required
                            class="w-full bg-gray-900/80 border border-gray-700/70 rounded-xl p-3 text-white placeholder-gray-500 
                                   focus:ring-2 focus:ring-cyan-500 focus:border-cyan-400 hover:border-cyan-400/60 
                                   hover:shadow-[0_0_10px_rgba(0,200,255,0.3)] outline-none transition duration-200"
                            placeholder="e.g., 192.168.1.0/24">
                    </div>

                    <!-- Interface -->
                    <div class="md:col-span-2">
                        <label for="interface" class="block text-sm font-medium text-gray-300 mb-2">Network Interface</label>
                        <input type="text" name="interface" id="interface" required
                            class="w-full bg-gray-900/80 border border-gray-700/70 rounded-xl p-3 text-white placeholder-gray-500 
                                   focus:ring-2 focus:ring-cyan-500 focus:border-cyan-400 hover:border-cyan-400/60 
                                   hover:shadow-[0_0_10px_rgba(0,200,255,0.3)] outline-none transition duration-200"
                            placeholder="e.g., eth0 or wlo1">
                    </div>

                    <!-- Submit -->
                    <div class="md:col-span-1">
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-cyan-600 via-blue-600 to-indigo-600 hover:from-cyan-700 
                                   hover:via-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-8 
                                   rounded-xl shadow-lg shadow-cyan-900/40 transform hover:scale-[1.03] active:scale-95 
                                   transition duration-300 ease-in-out tracking-wide flex items-center justify-center gap-2">
                            üîç <span>Start Scan</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== ŸÇÿ≥ŸÖ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ========== -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 fade-up">
        <div class="bg-gray-900/70 border border-gray-800 rounded-2xl p-5 shadow-lg 
                    hover:shadow-[0_0_15px_rgba(0,200,255,0.25)] transition transform hover:-translate-y-1">
            <h4 class="text-gray-400 text-sm uppercase">Total Devices</h4>
            <p class="text-3xl font-bold text-cyan-400 mt-2">{{ devices|length }}</p>
        </div>
        <div class="bg-gray-900/70 border border-gray-800 rounded-2xl p-5 shadow-lg 
                    hover:shadow-[0_0_15px_rgba(0,255,150,0.3)] transition transform hover:-translate-y-1">
            <h4 class="text-gray-400 text-sm uppercase">Active Hosts</h4>
            <p class="text-3xl font-bold text-green-400 mt-2">{{ devices|length }}</p>
        </div>
        <div class="bg-gray-900/70 border border-gray-800 rounded-2xl p-5 shadow-lg 
                    hover:shadow-[0_0_15px_rgba(180,100,255,0.3)] transition transform hover:-translate-y-1">
            <h4 class="text-gray-400 text-sm uppercase">Last Scan</h4>
            <p class="text-lg font-semibold text-gray-300 mt-2">
                {% if devices %}
                    {{ devices.0.last_seen|date:"Y-m-d H:i" }}
                {% else %}
                    -
                {% endif %}
            </p>
        </div>
    </div>

    <!-- ========== ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ© ========== -->
    <div class="relative border border-gray-800 rounded-2xl p-6 bg-gradient-to-br from-gray-900 via-gray-950 to-black 
                overflow-hidden shadow-[0_0_25px_rgba(0,200,255,0.1)] fade-up">
        <div class="absolute inset-0 bg-gradient-to-tl from-blue-700/10 via-transparent to-transparent blur-2xl"></div>

        <div class="relative z-10">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3 tracking-wide">
                <span class="text-blue-400 drop-shadow-[0_0_6px_rgba(0,200,255,0.6)]">üíª</span>
                Discovered Devices
            </h3>

            <div class="overflow-hidden border border-gray-800/70 rounded-xl backdrop-blur-sm">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="bg-gray-800/90 text-xs text-gray-400 uppercase tracking-wider">
                        <tr class="divide-x divide-gray-700">
                            <th class="px-5 py-3">IP Address</th>
                            <th class="px-5 py-3">MAC Address</th>
                            <th class="px-5 py-3">Hostname</th>
                            <th class="px-5 py-3">Vendor</th>
                            <th class="px-5 py-3">Last Seen</th>
                            <th class="px-5 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800/70">
                        {% for device in devices %}
                        <tr class="hover:bg-gray-800/60 hover:shadow-[0_0_10px_rgba(0,200,255,0.25)] transition duration-200">
                            <td class="px-5 py-3 font-mono">
                                <a href="{% url 'scanner' %}?url={{ device.ip_address }}" 
                                   class="text-cyan-400 hover:underline hover:text-blue-300 transition">
                                    {{ device.ip_address }}
                                </a>
                            </td>
                            <td class="px-5 py-3 font-mono text-gray-300">{{ device.mac_address }}</td>
                            <td class="px-5 py-3">{{ device.hostname|default:"-" }}</td>
                            <td class="px-5 py-3">{{ device.vendor|default:"-" }}</td>
                            <td class="px-5 py-3 text-gray-400">{{ device.last_seen|date:"Y-m-d H:i" }}</td>
                            <td class="px-5 py-3 text-center">
                                <form method="post" action="{% url 'audit_device' device.id %}">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="bg-gradient-to-r from-red-600 via-pink-600 to-rose-700 
                                                   hover:from-red-700 hover:via-pink-700 hover:to-rose-800 text-white 
                                                   text-xs font-bold py-1.5 px-4 rounded-lg shadow hover:shadow-red-500/30 
                                                   transition transform hover:scale-[1.05] active:scale-95">
                                        Audit
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-10 text-gray-600 italic">
                                üö´ No devices discovered yet. Run a scan to populate this table.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ========== ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ========== -->
<script>
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('visible');
        });
    }, { threshold: 0.15 });

    document.querySelectorAll('.fade-up').forEach(el => {
        el.classList.add('opacity-0', 'translate-y-6', 'transition-all', 'duration-1000');
        observer.observe(el);
    });

    const style = document.createElement('style');
    style.innerHTML = `.visible { opacity: 1 !important; transform: translateY(0) !important; }`;
    document.head.appendChild(style);
</script>

<!-- ========== ÿ≥ŸÉÿ±ÿ®ÿ™ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ≠ ========== -->
{% if is_scan_active %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.querySelector('#scan-button-container button');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Scanning...
            `;
        }
        setTimeout(() => window.location.reload(), 15000);
    });
</script>
{% endif %}
{% endblock %}
