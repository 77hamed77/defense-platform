<!-- core/templates/core/dashboard.html -->

{% extends "core/base.html" %}

{% block title %}Dashboard - Defense Platform{% endblock %}

{% block content %}
<div class="space-y-10 animate-fadeIn">

    <!-- 🧠 الإحصائيات العلوية -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Total Alerts -->
        <div class="bg-gradient-to-br from-red-900/60 via-gray-900 to-black border border-red-800/40 rounded-2xl p-6 text-center shadow-lg hover:shadow-red-600/30 transition">
            <h2 class="text-gray-400 font-semibold text-sm uppercase tracking-wider">Total Alerts</h2>
            <p class="text-4xl font-extrabold mt-2 text-red-400 drop-shadow-md">{{ total_alerts }}</p>
        </div>

        <!-- Managed Assets -->
        <div class="bg-gradient-to-br from-blue-900/60 via-gray-900 to-black border border-blue-800/40 rounded-2xl p-6 text-center shadow-lg hover:shadow-blue-600/30 transition">
            <h2 class="text-gray-400 font-semibold text-sm uppercase tracking-wider">Managed Assets</h2>
            <p class="text-4xl font-extrabold mt-2 text-blue-400 drop-shadow-md">{{ total_assets }}</p>
        </div>

        <!-- Tracked IOCs -->
        <div class="bg-gradient-to-br from-emerald-900/60 via-gray-900 to-black border border-emerald-800/40 rounded-2xl p-6 text-center shadow-lg hover:shadow-emerald-600/30 transition">
            <h2 class="text-gray-400 font-semibold text-sm uppercase tracking-wider">Tracked IOCs</h2>
            <p class="text-4xl font-extrabold mt-2 text-emerald-400 drop-shadow-md">{{ total_iocs }}</p>
        </div>
    </div>

    <!-- ⚙️ المحتوى الرئيسي -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- الرسم البياني -->
        <div class="bg-gray-900/70 backdrop-blur-sm border border-gray-800 rounded-2xl p-6 shadow-lg hover:shadow-blue-500/20 transition">
            <h2 class="text-xl font-bold mb-6 text-center text-white flex items-center justify-center gap-2">
                <span class="text-cyan-400">📊</span> Alerts by Severity
            </h2>
            <canvas id="severityChart" class="mx-auto"></canvas>
        </div>

        <!-- جدول التنبيهات -->
        <div class="bg-gray-900/70 backdrop-blur-sm border border-gray-800 rounded-2xl p-6 shadow-lg lg:col-span-2 hover:shadow-amber-500/20 transition">
            <h2 class="text-xl font-bold mb-6 text-white flex items-center gap-2">
                <span class="text-amber-400">🚨</span> Latest Alerts
            </h2>
            <div class="overflow-x-auto rounded-xl border border-gray-800">
                <table class="min-w-full text-sm text-left text-gray-300">
                    <thead class="bg-gray-800/60 text-gray-300 uppercase text-xs tracking-wider">
                        <tr>
                            <th class="p-3">Timestamp</th>
                            <th class="p-3">Severity</th>
                            <th class="p-3">Description</th>
                            <th class="p-3">Source IP</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        {% for alert in latest_alerts %}
                        <tr class="hover:bg-gray-800/40 transition">
                            <td class="p-3 whitespace-nowrap text-gray-400">{{ alert.timestamp|date:"Y-m-d H:i:s" }}</td>
                            <td class="p-3">
                                <span class="px-3 py-1 rounded-full text-xs font-bold severity-{{ alert.severity|lower }}">
                                    {{ alert.get_severity_display }}
                                </span>
                            </td>
                            <td class="p-3">
                                <a href="{% url 'alert-detail' alert.pk %}" class="text-blue-400 hover:text-blue-300 hover:underline transition">
                                    {{ alert.description|truncatechars:60 }}
                                </a>
                            </td>
                            <td class="p-3 font-mono text-gray-400">{{ alert.source_ip|default:"N/A" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center p-6 text-gray-500 italic">No alerts found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 🧩 الرسم البياني -->
{{ severity_labels|json_script:"severity-labels" }}
{{ severity_data|json_script:"severity-data" }}
<script>
    const severityLabels = JSON.parse(document.getElementById('severity-labels').textContent);
    const severityData = JSON.parse(document.getElementById('severity-data').textContent);

    const ctx = document.getElementById('severityChart').getContext('2d');

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: severityLabels,
            datasets: [{
                label: 'Alerts by Severity',
                data: severityData,
                backgroundColor: [
                    '#22c55e', // Low - Green
                    '#f59e0b', // Medium - Amber
                    '#ef4444', // High - Red
                    '#8b5cf6'  // Critical - Violet
                ],
                borderColor: '#111827',
                borderWidth: 2,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#d1d5db',
                        padding: 16,
                        boxWidth: 14
                    }
                }
            }
        }
    });
</script>
{% endblock %}
