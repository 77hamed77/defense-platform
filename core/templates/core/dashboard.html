<!-- core/templates/core/dashboard.html -->
{% extends "core/base.html" %}
{% block title %}Command Center Dashboard{% endblock %}

{% block content %}
<div class="relative overflow-hidden text-gray-200">
    <!-- üåå ÿÆŸÑŸÅŸäÿ© Matrix Rain -->
    <canvas id="matrixRain" class="fixed inset-0 w-full h-full -z-10"></canvas>
    <div class="absolute inset-0 bg-gradient-to-b from-black/90 via-[#001a0f]/90 to-black/95 -z-10"></div>

    <!-- üß† ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπŸÑŸàŸäÿ© ÿßŸÑŸÖÿ≠ÿØÿ´ÿ© -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 mt-6">
        <div class="relative p-6 rounded-2xl border border-red-700/50 bg-black/60 shadow-[0_0_25px_rgba(255,0,0,0.25)] text-center transition">
            <h2 class="text-red-400 text-sm font-semibold uppercase tracking-widest">New Critical Alerts</h2>
            <p class="text-5xl font-extrabold mt-3 text-red-300 drop-shadow-[0_0_10px_rgba(255,0,0,0.6)] counter" data-target="{{ critical_alerts_count }}">0</p>
        </div>
        <div class="relative p-6 rounded-2xl border border-yellow-700/50 bg-black/60 shadow-[0_0_25px_rgba(255,200,0,0.25)] text-center transition">
            <h2 class="text-yellow-400 text-sm font-semibold uppercase tracking-widest">Total Vulnerabilities</h2>
            <p class="text-5xl font-extrabold mt-3 text-yellow-300 drop-shadow-[0_0_10px_rgba(255,200,0,0.6)] counter" data-target="{{ total_vulnerabilities }}">0</p>
        </div>
        <div class="relative p-6 rounded-2xl border border-blue-700/50 bg-black/60 shadow-[0_0_25px_rgba(0,150,255,0.25)] text-center transition">
            <h2 class="text-blue-400 text-sm font-semibold uppercase tracking-widest">Network Devices</h2>
            <p class="text-5xl font-extrabold mt-3 text-blue-300 drop-shadow-[0_0_10px_rgba(0,150,255,0.6)] counter" data-target="{{ total_devices }}">0</p>
        </div>
    </div>

    <!-- ‚öôÔ∏è ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä (ÿπŸÖŸàÿØÿßŸÜ) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- ===== ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ£Ÿäÿ≥ÿ± ===== -->
        <div class="space-y-8">
            <!-- üö® ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ -->
            <div class="relative bg-black/60 border border-green-800/40 rounded-2xl p-6 shadow-[0_0_25px_rgba(0,255,100,0.2)] backdrop-blur-md">
                <h2 class="text-xl font-bold mb-6 text-green-300 flex items-center gap-2">üö® Recent Alerts</h2>
                <div class="overflow-x-auto rounded-xl border border-green-800/40">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <thead class="bg-green-950/50 text-green-400 uppercase text-xs tracking-wider">
                            <tr>
                                <th class="p-3">Timestamp</th>
                                <th class="p-3">Severity</th>
                                <th class="p-3">Description</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-green-900/40">
                            {% for alert in latest_alerts %}
                            <tr class="hover:bg-green-900/10 transition">
                                <td class="p-3 text-gray-400">{{ alert.timestamp|date:"Y-m-d H:i" }}</td>
                                <td class="p-3"><span class="px-3 py-1 rounded-full text-xs font-bold severity-{{ alert.severity|lower }}">{{ alert.get_severity_display }}</span></td>
                                <td class="p-3"><a href="{% url 'alert-detail' alert.pk %}" class="text-green-400 hover:underline">{{ alert.description|truncatechars:40 }}</a></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center p-6 text-gray-500 italic">No recent alerts.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- üöÄ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÅÿ≠Ÿàÿµÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ© -->
            <div class="relative bg-black/60 border border-blue-800/40 rounded-2xl p-6 shadow-[0_0_25px_rgba(0,150,255,0.2)] backdrop-blur-md">
                <h2 class="text-xl font-bold mb-6 text-blue-300 flex items-center gap-2">üöÄ Recent Scans</h2>
                <div class="overflow-x-auto rounded-xl border border-blue-800/40">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <thead class="bg-blue-950/50 text-blue-400 uppercase text-xs">
                            <tr><th class="p-3">Tool</th><th class="p-3">Target</th><th class="p-3">Date</th></tr>
                        </thead>
                        <tbody class="divide-y divide-blue-900/40">
                            {% for scan in latest_scans %}
                            <tr class="hover:bg-blue-900/10">
                                <td class="p-3 font-semibold">{{ scan.tool.name }}</td>
                                <td class="p-3 font-mono"><a href="{% url 'scan_detail' scan.id %}" class="text-blue-400 hover:underline">{{ scan.target_url|truncatechars:25 }}</a></td>
                                <td class="p-3 text-gray-400">{{ scan.created_at|timesince }} ago</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center p-6 text-gray-500 italic">No recent scans.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ‚òÅÔ∏è ÿ¨ÿØŸàŸÑ ŸÅÿ≠Ÿàÿµÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ© ÿßŸÑÿ£ÿÆŸäÿ±ÿ© -->
            <div class="relative bg-black/60 border border-purple-800/40 rounded-2xl p-6 shadow-[0_0_25px_rgba(200,100,255,0.2)] backdrop-blur-md">
                <h2 class="text-xl font-bold mb-6 text-purple-300 flex items-center gap-2">‚òÅÔ∏è Recent Cloud Audits</h2>
                <div class="overflow-x-auto rounded-xl border border-purple-800/40">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <thead class="bg-purple-950/50 text-purple-400 uppercase text-xs">
                            <tr><th class="p-3">Environment</th><th class="p-3">Status</th><th class="p-3">Date</th></tr>
                        </thead>
                        <tbody class="divide-y divide-purple-900/40">
                            {% for scan in latest_cloud_scans %}
                            <tr class="hover:bg-purple-900/10">
                                <td class="p-3 font-semibold">{{ scan.environment.name }}</td>
                                <td class="p-3"><a href="{% url 'cloud_scan_detail' scan.id %}" class="text-purple-400 hover:underline">{{ scan.get_status_display }}</a></td>
                                <td class="p-3 text-gray-400">{{ scan.created_at|timesince }} ago</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center p-6 text-gray-500 italic">No recent cloud audits.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===== ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑÿ£ŸäŸÖŸÜ ===== -->
        <div class="space-y-8">
            <!-- üåê ÿ¨ÿØŸàŸÑ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅÿ© -->
            <div class="relative bg-black/60 border border-cyan-800/40 rounded-2xl p-6 shadow-[0_0_25px_rgba(0,255,255,0.2)] backdrop-blur-md">
                <h2 class="text-xl font-bold mb-6 text-cyan-300 flex items-center gap-2">üåê Newly Discovered Devices</h2>
                <div class="overflow-x-auto rounded-xl border border-cyan-800/40">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <thead class="bg-cyan-950/50 text-cyan-400 uppercase text-xs">
                            <tr><th class="p-3">IP Address</th><th class="p-3">Vendor</th><th class="p-3">Seen</th></tr>
                        </thead>
                        <tbody class="divide-y divide-cyan-900/40">
                            {% for device in latest_devices %}
                            <tr class="hover:bg-cyan-900/10">
                                <td class="p-3 font-mono"><a href="{% url 'scanner' %}?url={{ device.ip_address }}" class="text-cyan-400 hover:underline">{{ device.ip_address }}</a></td>
                                <td class="p-3">{{ device.vendor|default:"Unknown"|truncatechars:20 }}</td>
                                <td class="p-3 text-gray-400">{{ device.last_seen|timesince }} ago</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center p-6 text-gray-500 italic">No devices discovered.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- üé£ ÿ¨ÿØŸàŸÑ ÿ≠ŸÖŸÑÿßÿ™ ÿßŸÑÿ™ÿµŸäÿØ ÿßŸÑÿ£ÿÆŸäÿ±ÿ© -->
            <div class="relative bg-black/60 border border-pink-800/40 rounded-2xl p-6 shadow-[0_0_25px_rgba(255,100,200,0.2)] backdrop-blur-md">
                <h2 class="text-xl font-bold mb-6 text-pink-300 flex items-center gap-2">üé£ Recent Phishing Campaigns</h2>
                <div class="overflow-x-auto rounded-xl border border-pink-800/40">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <thead class="bg-pink-950/50 text-pink-400 uppercase text-xs">
                            <tr>
                                <th class="p-3">Campaign</th>
                                <th class="p-3 text-center">Clicked</th>
                                <th class="p-3 text-center">Submitted</th>
                                <th class="p-3">Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-pink-900/40">
                            {% for campaign in latest_phishing_campaigns %}
                            <tr class="hover:bg-pink-900/10">
                                <td class="p-3 font-semibold">
                                    <a href="{% url 'phishing_campaign_detail' campaign.id %}" class="text-pink-400 hover:underline">
                                        {{ campaign.name|truncatechars:20 }}
                                    </a>
                                </td>
                               <td class="p-3 text-center font-mono">{{ campaign.clicked_count }}</td>
                                <td class="p-3 text-center font-mono text-red-400 font-bold">{{ campaign.submitted_count }}</td>
                                <td class="p-3 text-gray-400">{{ campaign.created_at|timesince }} ago</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center p-6 text-gray-500 italic">No phishing campaigns launched.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- üî¨ ÿ¨ÿØŸàŸÑ ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ APK ÿßŸÑÿ£ÿÆŸäÿ±ÿ© -->
            <div class="relative bg-black/60 border border-yellow-800/40 rounded-2xl p-6 shadow-[0_0_25px_rgba(255,200,0,0.2)] backdrop-blur-md">
                <h2 class="text-xl font-bold mb-6 text-yellow-300 flex items-center gap-2">üî¨ Recent APK Analyses</h2>
                <div class="overflow-x-auto rounded-xl border border-yellow-800/40">
                    <table class="min-w-full text-sm text-left text-gray-300">
                        <thead class="bg-yellow-950/50 text-yellow-400 uppercase text-xs">
                            <tr><th class="p-3">Filename</th><th class="p-3">Status</th><th class="p-3">Date</th></tr>
                        </thead>
                        <tbody class="divide-y divide-yellow-900/40">
                            {% for analysis in latest_apk_analyses %}
                            <tr class="hover:bg-yellow-900/10">
                                <td class="p-3 font-mono"><a href="{% url 'apk_analysis_detail' analysis.id %}" class="text-yellow-400 hover:underline">{{ analysis.filename|truncatechars:25 }}</a></td>
                                <td class="p-3">{{ analysis.get_status_display }}</td>
                                <td class="p-3 text-gray-400">{{ analysis.created_at|timesince }} ago</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center p-6 text-gray-500 italic">No recent APK analyses.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üß© Animation Scripts -->
<script>
/* ===================== üî¢ Animated Counters ===================== */
document.querySelectorAll('.counter').forEach(counter => {
  const target = +counter.dataset.target;
  if (isNaN(target)) return;
  const duration = 1500;
  let current = 0;
  const increment = target / (duration / 16);

  function update() {
    current += increment;
    if (current >= target) {
      counter.textContent = target.toLocaleString();
      return;
    }
    counter.textContent = Math.ceil(current).toLocaleString();
    requestAnimationFrame(update);
  }
  update();
});

/* ===================== üåßÔ∏è Matrix Rain Background ===================== */
const canvas = document.getElementById("matrixRain");
if (canvas) {
    const c = canvas.getContext("2d");
    canvas.height = window.innerHeight;
    canvas.width = window.innerWidth;
    const chars = "01";
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);

    function draw() {
      c.fillStyle = "rgba(0,0,0,0.08)";
      c.fillRect(0, 0, canvas.width, canvas.height);
      c.fillStyle = "#00ff88";
      c.font = fontSize + "px monospace";
      for (let i = 0; i < drops.length; i++) {
        const text = chars.charAt(Math.floor(Math.random() * chars.length));
        c.fillText(text, i * fontSize, drops[i] * fontSize);
        if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
        drops[i]++;
      }
    }
    const matrixInterval = setInterval(draw, 40);
    window.addEventListener("resize", () => {
      canvas.height = window.innerHeight;
      canvas.width = window.innerWidth;
    });
}
</script>

<style>
.severity-low { background-color: #22c55e30; color: #22c55e; border: 1px solid #22c55e80;}
.severity-medium { background-color: #eab30830; color: #eab308; border: 1px solid #eab30880;}
.severity-high { background-color: #f9731630; color: #f97316; border: 1px solid #f9731680;}
.severity-critical { background-color: #dc262630; color: #f87171; border: 1px solid #dc262680;}
</style>
{% endblock %}