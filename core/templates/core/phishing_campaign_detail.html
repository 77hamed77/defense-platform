{% extends "core/base.html" %}

{% block title %}Campaign Report: {{ campaign.name }}{% endblock %}

{% block content %}
<div class="relative overflow-hidden min-h-screen">

  <!-- ===== CYBER GREEN BACKGROUND ===== -->
  <canvas id="cyber-grid" class="fixed inset-0 w-full h-full -z-50"></canvas>
  <div class="fixed inset-0 -z-40 bg-gradient-to-b from-black/85 via-[#00110a]/95 to-[#001b13]/98 backdrop-blur-sm"></div>

  <!-- ===== MOUSE GLOW TRAIL ===== -->
  <div id="mouse-glow" class="fixed w-32 h-32 bg-emerald-400/25 rounded-full blur-3xl -z-30 pointer-events-none"></div>

  <!-- ===== PAGE CONTENT ===== -->
  <div class="relative z-10 space-y-8 p-6 max-w-7xl mx-auto animate-fadeIn">

    <!-- Header Section - Enhanced -->
    <div class="border-b-2 border-emerald-600/40 pb-6">
      <div class="flex items-start justify-between mb-4">
        <div>
          <a href="{% url 'phishing_campaign_list' %}" class="inline-flex items-center text-sm text-emerald-400 hover:text-emerald-300 transition-colors font-semibold gap-2">
            <span>‚Üê</span> Back to Campaigns
          </a>
          <h1 class="text-5xl md:text-6xl font-black text-white mt-4 tracking-tighter">
            Campaign Report
          </h1>
          <p class="text-2xl font-bold text-emerald-400 mt-2">{{ campaign.name }}</p>
        </div>
        <div class="bg-emerald-900/30 border-2 border-emerald-500/50 rounded-lg px-6 py-4 text-center backdrop-blur-md">
          <p class="text-xs font-mono text-emerald-300 uppercase tracking-widest">Status</p>
          <p class="text-xl font-bold text-emerald-400 mt-1">{{ campaign.get_status_display }}</p>
        </div>
      </div>
    </div>

    <!-- Risk Grade Card - Premium -->
    <div class="relative rounded-2xl p-8 bg-gradient-to-br from-emerald-900/20 via-[#02120b]/80 to-[#001b13]/90 border-2 border-emerald-500/40 backdrop-blur-md shadow-[0_0_60px_rgba(0,255,150,0.1)] hover:shadow-[0_0_80px_rgba(0,255,180,0.2)] transition-all duration-300">
      <div class="absolute inset-0 bg-gradient-to-br from-emerald-400/10 via-transparent to-transparent blur-3xl rounded-2xl"></div>
      <div class="relative z-10">
        <h2 class="text-sm font-mono text-emerald-300 uppercase tracking-widest mb-6 opacity-80">[RISK_ASSESSMENT]</h2>
        <div class="flex items-center justify-between gap-8">
          <div class="flex items-center gap-6">
            <div class="flex-shrink-0 w-40 h-40 rounded-full border-4 border-emerald-400 bg-emerald-950/60 flex items-center justify-center shadow-[0_0_30px_rgba(0,255,150,0.3)]">
              <span class="text-7xl font-black text-emerald-300">{{ risk_grade }}</span>
            </div>
            <div>
              <h3 class="text-2xl font-bold text-white">Overall Risk Grade</h3>
              <p class="text-lg font-bold text-emerald-400 mt-2">{{ risk_description }}</p>
              <p class="text-xs text-emerald-300/60 mt-3 font-mono">‚Ä¢ Click Rate: {{ click_rate|floatformat:1 }}% | Submission Rate: {{ submission_rate|floatformat:1 }}%</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Executive Summary - Dark Terminal Style -->
    <div class="border-2 border-emerald-600/30 rounded-xl shadow-lg p-8 bg-[#01150c]/95 backdrop-blur-md">
      <h3 class="text-lg font-mono text-emerald-300 mb-4 uppercase tracking-wider flex items-center gap-3">
        <span class="text-emerald-400">‚ö†</span> [RISK_EXECUTIVE_SUMMARY]
      </h3>
      <div class="bg-black/50 border border-emerald-600/30 rounded-lg p-6 font-mono text-sm text-emerald-200 leading-relaxed space-y-3">
        <p>The phishing simulation campaign, "<span class="text-emerald-400 font-bold">{{ campaign.name }}</span>" revealed critical vulnerabilities:</p>
        <div class="ml-4 space-y-2 border-l-2 border-emerald-600/50 pl-4">
          <p>‚Üí <span class="text-yellow-400 font-semibold">{{ click_rate|floatformat:1 }}%</span> of targets clicked malicious link</p>
          <p>‚Üí <span class="text-red-400 font-semibold">{{ submission_rate|floatformat:1 }}%</span> submitted credentials</p>
          <p>‚Üí <span class="text-red-500">CRITICAL</span> risk of account compromise & data breach</p>
        </div>
        <p class="text-xs text-emerald-300/50 mt-4">[IMMEDIATE INTERVENTION REQUIRED]</p>
      </div>
    </div>

    <!-- Stats Grid - Enhanced -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <!-- Sent -->
      <div class="stat-card-premium">
        <p class="text-xs font-mono text-emerald-300 uppercase tracking-wider opacity-70">[SENT]</p>
        <p class="text-4xl font-black text-emerald-400 mt-3">{{ sent_count }}<span class="text-lg text-emerald-600">/{{ total_targets }}</span></p>
      </div>
      <!-- Opened -->
      <div class="stat-card-premium">
        <p class="text-xs font-mono text-emerald-300 uppercase tracking-wider opacity-70">[OPENED]</p>
        <p class="text-4xl font-black text-emerald-400 mt-3">{{ opened_count }}</p>
        <p class="text-xs text-emerald-500 mt-2 font-mono">{{ open_rate|floatformat:1 }}%</p>
      </div>
      <!-- Clicked -->
      <div class="stat-card-premium border-yellow-600/40">
        <p class="text-xs font-mono text-yellow-300 uppercase tracking-wider opacity-70">[CLICKED]</p>
        <p class="text-4xl font-black text-yellow-400 mt-3">{{ clicked_count }}</p>
        <p class="text-xs text-yellow-500 mt-2 font-mono">{{ click_rate|floatformat:1 }}%</p>
      </div>
      <!-- Submitted -->
      <div class="stat-card-premium border-red-600/40">
        <p class="text-xs font-mono text-red-300 uppercase tracking-wider opacity-70">[SUBMITTED]</p>
        <p class="text-4xl font-black text-red-400 mt-3">{{ submitted_count }}</p>
        <p class="text-xs text-red-500 mt-2 font-mono">{{ submission_rate|floatformat:1 }}%</p>
      </div>
    </div>

    <!-- User Behavior Analysis -->
    {% if average_time_to_click is not None %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="border-2 border-emerald-600/30 rounded-xl p-8 bg-[#01150c]/80 backdrop-blur-md">
        <h4 class="text-sm font-mono text-emerald-300 uppercase tracking-wider mb-4">[AVG_TIME_TO_CLICK]</h4>
        <p class="text-5xl font-black text-emerald-300">{{ average_time_to_click }}<span class="text-lg font-semibold text-emerald-600 ml-2">sec</span></p>
        <p class="text-xs text-emerald-500/70 mt-3 font-mono">Average time between email receipt and link click</p>
      </div>
      {% if fastest_click_result %}
      <div class="border-2 border-emerald-600/30 rounded-xl p-8 bg-[#01150c]/80 backdrop-blur-md">
        <h4 class="text-sm font-mono text-emerald-300 uppercase tracking-wider mb-4">[FASTEST_RESPONDER]</h4>
        <p class="text-lg font-mono text-white break-all mb-3">{{ fastest_click_result.target.email }}</p>
        <p class="text-emerald-400 font-bold text-sm">Clicked in <span class="text-red-400">{{ fastest_click_result.time_to_click.total_seconds|floatformat:0 }}s</span></p>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Top At-Risk Targets -->
    {% if at_risk_results.exists %}
    <div class="border-2 border-red-600/40 rounded-xl p-8 bg-red-950/20 backdrop-blur-md">
      <h3 class="text-lg font-mono text-red-300 mb-6 uppercase tracking-wider flex items-center gap-3">
        <span class="animate-pulse text-red-500">‚óè</span> [CRITICAL_TARGETS_AT_RISK]
      </h3>
      <div class="overflow-hidden border border-red-800/50 rounded-lg">
        <table class="w-full text-sm text-left text-gray-300 font-mono">
          <thead class="bg-red-950/60 text-xs text-red-300 uppercase tracking-wider">
            <tr>
              <th class="px-6 py-4">Name</th>
              <th class="px-6 py-4">Email</th>
              <th class="px-6 py-4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-red-800/30">
            {% for result in at_risk_results %}
            <tr class="hover:bg-red-900/30 transition-all duration-300 border-l-4 border-red-600/50">
              <td class="px-6 py-4 font-semibold text-red-200">{{ result.target.name|default:"N/A" }}</td>
              <td class="px-6 py-4 text-red-300 break-all">{{ result.target.email }}</td>
              <td class="px-6 py-4">
                <div class="flex items-center justify-center space-x-3 text-lg">
                  <span class="text-green-400">üì¨</span>
                  <span class="text-yellow-400">üñ±Ô∏è</span>
                  <span class="text-red-500 font-bold">üîë</span>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- Geographic Distribution Map -->
    {% if locations_data %}
    <div class="border-2 border-emerald-600/30 rounded-xl p-8 bg-[#01150c]/80 backdrop-blur-md">
      <h3 class="text-lg font-mono text-emerald-300 mb-6 uppercase tracking-wider flex items-center gap-3">
        <span class="text-emerald-400">üìç</span> [GEO_DISTRIBUTION]
      </h3>
      <div id="map" class="w-full h-96 rounded-lg border-2 border-emerald-600/40"></div>
    </div>
    {% endif %}

    <!-- Target Results Table -->
    <div class="bg-[#011510]/90 border-2 border-emerald-600/30 rounded-2xl p-8 shadow-lg backdrop-blur-md overflow-hidden">
      <h3 class="text-2xl font-mono text-white mb-6 uppercase tracking-wider">
        <span class="text-emerald-400">[</span>TARGET_RESULTS<span class="text-emerald-400">]</span>
      </h3>
      <div class="overflow-x-auto rounded-lg border border-emerald-700/50">
        <table class="w-full text-sm text-left text-gray-300 font-mono">
          <thead class="bg-emerald-950/80 text-xs text-emerald-200 uppercase tracking-wider">
            <tr>
              <th class="px-6 py-4 font-semibold">Target</th>
              <th class="px-6 py-4 text-center font-semibold">Sent</th>
              <th class="px-6 py-4 text-center font-semibold">Opened</th>
              <th class="px-6 py-4 text-center font-semibold">Clicked</th>
              <th class="px-6 py-4 text-center font-semibold">Data Submitted</th>
              <th class="px-6 py-4 text-center font-semibold">Evidence</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800/50">
            {% for result in results %}
            <tr class="hover:bg-emerald-900/20 transition-colors duration-200 hover:border-l-4 hover:border-emerald-400">
              <td class="px-6 py-4 text-gray-200 break-all">{{ result.target.email }}</td>
              <td class="px-6 py-4 text-center text-emerald-400">{% if result.is_sent %}‚úî{% else %}‚úó{% endif %}</td>
              <td class="px-6 py-4 text-center text-emerald-400">{% if result.is_opened %}‚úî{% else %}‚úó{% endif %}</td>
              <td class="px-6 py-4 text-center text-yellow-400">{% if result.is_clicked %}‚úî{% else %}‚úó{% endif %}</td>
              <td class="px-6 py-4 text-center">
                {% if result.submitted_data %}
                  <span class="font-bold text-red-400 cursor-help" title="{{ result.captured_data }}">‚úî YES</span>
                {% else %}
                  <span class="text-gray-600">‚úó</span>
                {% endif %}
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center justify-center space-x-2 text-lg">
                  {% if result.captured_user_agent %}
                    <span title="{{ result.captured_user_agent }}" class="cursor-help text-gray-400 hover:text-emerald-300 transition-colors">üíª</span>
                  {% endif %}
                  {% if result.captured_geolocation.latitude %}
                    <a href="https://www.google.com/maps?q={{ result.captured_geolocation.latitude }},{{ result.captured_geolocation.longitude }}" 
                       target="_blank" class="text-emerald-400 hover:text-emerald-300 transition-colors">üìç</a>
                  {% endif %}
                  {% if result.captured_image_path %}
                    <a href="{{ MEDIA_URL }}{{ result.captured_image_path }}" 
                       target="_blank" class="text-purple-400 hover:text-purple-300 transition-colors">üì∏</a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-8 text-gray-600 italic font-mono">
                [NO_RESULTS_AVAILABLE]
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Actionable Recommendations -->
    <div class="border-2 border-emerald-600/30 rounded-xl p-8 bg-[#01150c]/80 backdrop-blur-md">
      <h3 class="text-lg font-mono text-emerald-300 mb-6 uppercase tracking-wider flex items-center gap-3">
        <span class="text-emerald-400">‚Üí</span> [RECOMMENDATIONS]
      </h3>
      <div class="space-y-5">
        <div class="border-l-4 border-red-500 pl-6 py-4 bg-red-950/30 rounded-r-lg">
          <h4 class="font-bold text-red-300 text-sm uppercase tracking-wider mb-2">1. Targeted Training [HIGH_PRIORITY]</h4>
          <p class="text-gray-300 text-sm font-mono">Enroll all employees who submitted credentials into mandatory intensive security awareness and phishing training. Complete within 30 days.</p>
        </div>

        <div class="border-l-4 border-yellow-500 pl-6 py-4 bg-yellow-950/30 rounded-r-lg">
          <h4 class="font-bold text-yellow-300 text-sm uppercase tracking-wider mb-2">2. General Awareness Campaign</h4>
          <p class="text-gray-300 text-sm font-mono">Distribute company-wide email with anonymized simulation results. Reinforce phishing identification best practices and reporting procedures.</p>
        </div>

        <div class="border-l-4 border-emerald-500 pl-6 py-4 bg-emerald-950/30 rounded-r-lg">
          <h4 class="font-bold text-emerald-300 text-sm uppercase tracking-wider mb-2">3. Technical Control Review</h4>
          <p class="text-gray-300 text-sm font-mono">Review email security gateway configurations. Enable advanced features: ATP, URL Sandboxing, Attachment Detonation to reduce malicious email delivery.</p>
        </div>
      </div>
    </div>

  </div>

  <!-- ===== BACKGROUND ANIMATION & MOUSE GLOW ===== -->
  <script>
  (() => {
    const canvas = document.getElementById('cyber-grid');
    const ctx = canvas.getContext('2d');
    let W, H, t = 0;

    function resize() {
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function draw() {
      ctx.fillStyle = 'rgba(24, 24, 24, 0.27)';
      ctx.fillRect(0,0,W,H);

      const gridSize = 50;
      ctx.strokeStyle = 'rgba(45, 141, 0, 0.37)';
      ctx.lineWidth = 5;

      for (let y=0; y<H; y+=gridSize) {
        ctx.beginPath();
        for (let x=0; x<W; x+=gridSize) {
          const wave = Math.sin((x+t)*0.012)*8 + Math.cos((y+t)*0.018)*8;
          ctx.lineTo(x, y+wave);
        }
        ctx.stroke();
      }

      for (let x=0; x<W; x+=gridSize) {
        ctx.beginPath();
        for (let y=0; y<H; y+=gridSize) {
          const wave = Math.sin((y+t)*0.009)*8 + Math.cos((x+t)*0.013)*8;
          ctx.lineTo(x+wave, y);
        }
        ctx.stroke();
      }

      for (let i=0; i<80; i++) {
        const px = (Math.sin(t/15 + i)*W)/2 + W/2;
        const py = (Math.cos(t/20 + i)*H)/2 + H/2;
        ctx.fillStyle = `rgba(0,255,180,${Math.random()*0.4})`;
        ctx.beginPath();
        ctx.arc(px, py, 2.5, 0, Math.PI*2);
        ctx.fill();
      }
      t += 1;
      requestAnimationFrame(draw);
    }
    draw();

    const mouseGlow = document.getElementById('mouse-glow');
    document.addEventListener('mousemove', e => {
      mouseGlow.style.transform = `translate(${e.clientX - 64}px, ${e.clientY - 64}px)`;
    });
  })();
  </script>

  <!-- ===== LEAFLET MAP ===== -->
  {{ locations_data|json_script:"locations-data" }}
  <script>
  document.addEventListener('DOMContentLoaded', function () {
      const locations = JSON.parse(document.getElementById('locations-data').textContent);
      if (locations && locations.length > 0 && document.getElementById('map')) {
          const map = L.map('map').setView([20, 10], 2);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          locations.forEach(loc => {
              if (loc.lat && loc.lng) {
                  L.marker([loc.lat, loc.lng]).addTo(map)
                      .bindPopup(`<b>${loc.email}</b>`);
              }
          });
      }
  });
  </script>

  <!-- ===== ENHANCED STYLES ===== -->
  <style>
    .stat-card-premium {
      background: linear-gradient(to bottom, #051810, #001a0f);
      border: 2px solid rgba(0,255,150,0.3);
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 0 30px rgba(0,255,150,0.08), inset 0 0 20px rgba(0,255,150,0.02);
      transition: all 0.3s ease;
      text-align: center;
    }
    .stat-card-premium:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 0 50px rgba(0,255,150,0.2), inset 0 0 20px rgba(0,255,150,0.05);
      border-color: rgba(0,255,150,0.6);
    }
  </style>

</div>
{% endblock %}