<!-- core/templates/core/scan_detail.html -->
{% extends "core/base.html" %}

{% block title %}Scan Report â€” {{ scan.target_url }}{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-start justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                <span class="text-blue-400">ğŸ§¾</span>
                Scan Report
            </h1>
            <p class="text-gray-400 mt-1">
                Target: <span class="font-mono text-sm text-gray-200">{{ scan.target_url }}</span>
                &nbsp;â€¢&nbsp;
                Status: <strong class="ml-1">{{ scan.get_status_display }}</strong>
            </p>
            <p class="text-gray-500 text-sm mt-1">
                Started: {{ scan.created_at|date:"Y-m-d H:i" }}
                {% if scan.completed_at %} â€¢ Completed: {{ scan.completed_at|date:"Y-m-d H:i" }}{% endif %}
            </p>
        </div>

        <div class="flex items-center gap-3">
            <a href="{% url 'scanner' %}" class="inline-flex items-center gap-2 bg-gray-800 text-gray-200 px-4 py-2 rounded-lg shadow hover:bg-gray-700">
                â† Back
            </a>

            <button id="download-json"
                    class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
                â¤“ Download JSON
            </button>
        </div>
    </div>

    <!-- Summary card -->
    <div class="bg-gradient-to-r from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 shadow-md">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">ğŸ“Š Summary</h2>
                <p class="text-gray-400 mt-1">
                    Vulnerabilities found:
                    <span class="font-bold {% if scan.vulnerabilities.count > 0 %}text-red-400{% else %}text-green-400{% endif %}">
                        {{ scan.vulnerabilities.count }}
                    </span>
                </p>
            </div>
            <div class="text-sm text-gray-400">
                Scan ID: <span class="font-mono">{{ scan.id }}</span>
            </div>
        </div>
    </div>

    <!-- Vulnerabilities list -->
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-md">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">ğŸ›¡ï¸ Vulnerabilities</h3>

        {% if vulnerabilities.exists %}
        <div class="space-y-4">
            {% for vuln in vulnerabilities %}
            <div class="border border-gray-800 rounded-lg p-4 bg-gray-950 hover:border-indigo-600 transition">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <!-- Severity badge -->
                            {% with sev=vuln.severity|default:"N/A" %}
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                                    {% if sev|add:0 >= 8 %}
                                        bg-red-600 text-white
                                    {% elif sev|add:0 >= 5 %}
                                        bg-orange-500 text-white
                                    {% elif sev|add:0 >= 3 %}
                                        bg-yellow-500 text-black
                                    {% elif sev|add:0 >= 1 %}
                                        bg-green-600 text-white
                                    {% else %}
                                        bg-gray-700 text-gray-200
                                    {% endif %}">
                                    Severity: {{ sev }}
                                </span>
                            {% endwith %}

                            <!-- Short description -->
                            <h4 class="text-sm font-semibold text-white">
                                {{ vuln.description|default:"(No description)" }}
                            </h4>
                        </div>

                        <!-- metadata -->
                        <p class="text-xs text-gray-400 mt-2">
                            ğŸ”‘ ID: <span class="font-mono">{{ vuln.id }}</span>
                            {% if vuln.details.url %} â€¢ ğŸŒ URL: <span class="font-mono">{{ vuln.details.url }}</span>{% endif %}
                            {% if vuln.details.method %} â€¢ ğŸ”§ Method: {{ vuln.details.method }}{% endif %}
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-col items-end gap-2">
                        <button class="copy-btn inline-flex items-center gap-2 text-xs bg-gray-800 text-gray-200 px-3 py-1 rounded hover:bg-gray-700"
                                data-details="{{ vuln.details|escapejs }}">
                            ğŸ“‹ Copy JSON
                        </button>

                        <button class="toggle-btn inline-flex items-center gap-2 text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">
                            â–¾ Details
                        </button>
                    </div>
                </div>

                <!-- Collapsible details -->
                <div class="mt-3 details-panel hidden bg-gray-900 border border-gray-800 rounded p-3">
                    <pre class="text-sm leading-relaxed overflow-auto max-h-60 text-gray-200" style="white-space: pre-wrap; font-family: monospace;">
{{ vuln.details|default:"{}" }}
                    </pre>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <p class="text-gray-400 italic">âœ… No vulnerabilities found for this scan.</p>
        {% endif %}
    </div>
</div>

<!-- Small JS helpers -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Toggle details panels
    document.querySelectorAll('.toggle-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            const container = btn.closest('.border');
            const panel = container.querySelector('.details-panel');
            if (!panel) return;
            panel.classList.toggle('hidden');
            btn.textContent = panel.classList.contains('hidden') ? "â–¾ Details" : "â–´ Hide";
        });
    });

    // Copy single vulnerability JSON to clipboard
    document.querySelectorAll('.copy-btn').forEach(function(btn){
        btn.addEventListener('click', async function(){
            const details = btn.getAttribute('data-details') || '{}';
            try {
                await navigator.clipboard.writeText(details);
                btn.textContent = 'âœ… Copied';
                setTimeout(() => btn.textContent = 'ğŸ“‹ Copy JSON', 1500);
            } catch (err) {
                btn.textContent = 'âŒ Failed';
                setTimeout(() => btn.textContent = 'ğŸ“‹ Copy JSON', 1500);
            }
        });
    });

    // Download all vulnerabilities as JSON
    const downloadBtn = document.getElementById('download-json');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function () {
            const rows = document.querySelectorAll('.copy-btn');
            const items = [];
            rows.forEach(function(r){
                try {
                    const raw = r.getAttribute('data-details') || '{}';
                    let parsed;
                    try { parsed = JSON.parse(raw); }
                    catch(parseErr) { parsed = raw; }
                    items.push(parsed);
                } catch (e) {}
            });

            const blob = new Blob([JSON.stringify(items, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scan_{{ scan.id }}_vulnerabilities.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    }
});
</script>
{% endblock %}
