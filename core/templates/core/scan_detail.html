<!-- core/templates/core/scan_detail.html -->
{% extends "core/base.html" %}

{% block title %}Scan Report — {{ scan.target_url }}{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-start justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                <span class="text-blue-400">🧾</span>
                Scan Report
            </h1>
            <p class="text-gray-400 mt-1">
                Target: <span class="font-mono text-sm text-gray-200">{{ scan.target_url }}</span>
                &nbsp;•&nbsp;
                Status: <strong class="ml-1">{{ scan.get_status_display }}</strong>
            </p>
            <p class="text-gray-500 text-sm mt-1">
                Started: {{ scan.created_at|date:"Y-m-d H:i" }}
                {% if scan.completed_at %} • Completed: {{ scan.completed_at|date:"Y-m-d H:i" }}{% endif %}
            </p>
        </div>

        <div class="flex items-center gap-3">
            <a href="{% url 'scanner' %}" class="inline-flex items-center gap-2 bg-gray-800 text-gray-200 px-4 py-2 rounded-lg shadow hover:bg-gray-700">
                ← Back
            </a>

            <button id="download-json"
                    class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
                ⤓ Download JSON
            </button>
        </div>
    </div>

    <!-- Summary card -->
    <div class="bg-gradient-to-r from-gray-900 to-gray-800 border border-gray-700 rounded-xl p-6 shadow-md">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-lg font-semibold text-white flex items-center gap-2">📊 Summary</h2>
                <p class="text-gray-400 mt-1">
                    Vulnerabilities found:
                    <span class="font-bold {% if scan.vulnerabilities.count > 0 %}text-red-400{% else %}text-green-400{% endif %}">
                        {{ scan.vulnerabilities.count }}
                    </span>
                </p>
            </div>
            <div class="text-sm text-gray-400">
                Scan ID: <span class="font-mono">{{ scan.id }}</span>
            </div>
        </div>
    </div>

    <!-- Vulnerabilities list -->
    <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 shadow-md">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">🛡️ Vulnerabilities</h3>

        {% if vulnerabilities.exists %}
        <div class="space-y-4">
            {% for vuln in vulnerabilities %}
            <div class="border border-gray-800 rounded-lg p-4 bg-gray-950 hover:border-indigo-600 transition">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <!-- Severity badge -->
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-200">
                                Severity: {{ vuln.severity|default:"N/A" }}
                            </span>

                            <!-- Short description -->
                            <h4 class="text-base font-semibold text-white">
                                {{ vuln.description|default:"(No description)" }}
                            </h4>
                        </div>

                        <!-- metadata -->
                        <p class="text-xs text-gray-400 mt-2">
                            🔑 Finding ID: <span class="font-mono">{{ vuln.id }}</span>
                            {% if vuln.details.url %} • 🌐 URL: <span class="font-mono">{{ vuln.details.url }}</span>{% endif %}
                            {% if vuln.details.method %} • 🔧 Method: {{ vuln.details.method }}{% endif %}
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-col items-end gap-2">
                        <button class="copy-btn inline-flex items-center gap-2 text-xs bg-gray-800 text-gray-200 px-3 py-1 rounded hover:bg-gray-700"
                                data-details="{{ vuln.details|escapejs }}">
                            📋 Copy JSON
                        </button>

                        <button class="toggle-btn inline-flex items-center gap-2 text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">
                            ▾ Details
                        </button>
                        
                        <!-- Metasploit Exploit Button -->
    <form method="post" action="{% url 'test_exploit' vuln.id %}" onsubmit="return confirm('WARNING: This will attempt to actively exploit the target. Proceed only with explicit authorization.');">
        {% csrf_token %}
        <button type="submit" class="inline-flex items-center gap-2 text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
            🔥 Test Exploit
        </button>
    </form>
                    </div>
                </div>

                <!-- Collapsible details -->
                <div class="mt-3 details-panel hidden bg-gray-900 border border-gray-800 rounded p-3">
                    <pre class="text-sm leading-relaxed overflow-auto max-h-60 text-gray-200" style="white-space: pre-wrap; font-family: monospace;">{{ vuln.details|default:"{}"|pprint }}</pre>
                </div>
            </div>
            {% endfor %}
        </div>

        {% else %}
        <p class="text-gray-400 italic">✅ No vulnerabilities found for this scan.</p>
        {% endif %}
    </div>
</div>

<!-- Small JS helpers -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Toggle details panels
    document.querySelectorAll('.toggle-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            const container = btn.closest('.border');
            const panel = container.querySelector('.details-panel');
            if (!panel) return;
            panel.classList.toggle('hidden');
            btn.textContent = panel.classList.contains('hidden') ? "▾ Details" : "▴ Hide";
        });
    });

    // Copy single vulnerability JSON to clipboard
    document.querySelectorAll('.copy-btn').forEach(function(btn){
        btn.addEventListener('click', async function(){
            const detailsJson = btn.getAttribute('data-details') || '{}';
            try {
                // Format the JSON for readability before copying
                const formattedJson = JSON.stringify(JSON.parse(detailsJson), null, 2);
                await navigator.clipboard.writeText(formattedJson);
                btn.textContent = '✅ Copied';
                setTimeout(() => btn.textContent = '📋 Copy JSON', 1500);
            } catch (err) {
                btn.textContent = '❌ Failed';
                setTimeout(() => btn.textContent = '📋 Copy JSON', 1500);
            }
        });
    });

    // Download all vulnerabilities as JSON
    const downloadBtn = document.getElementById('download-json');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function () {
            const rows = document.querySelectorAll('.copy-btn');
            const items = [];
            rows.forEach(function(r){
                try {
                    const raw = r.getAttribute('data-details') || '{}';
                    items.push(JSON.parse(raw));
                } catch (e) {}
            });

            const blob = new Blob([JSON.stringify(items, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scan_{{ scan.id }}_vulnerabilities.json';
            document.body.appendChild(a);
a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    }
});
</script>
{% endblock %}