{% extends "core/base.html" %}
{% block title %}Cloud Security Dashboard{% endblock %}

{% block content %}
<div class="space-y-10 animate-fadeIn relative overflow-hidden">

    <!-- üåå ÿÆŸÑŸÅŸäÿ© ÿ±ŸÇŸÖŸäÿ© ŸÖÿ™ÿ≠ÿ±ŸÉÿ© (Matrix Rain + Waves + Glow Particles) -->
    <canvas id="matrixRain" class="fixed inset-0 w-full h-full -z-20"></canvas>
    <canvas id="cyberWaves" class="fixed inset-0 w-full h-full -z-10"></canvas>
    <div class="fixed inset-0 bg-gradient-to-br from-[#010a0a] via-[#001312] to-[#000a05] opacity-95 -z-30"></div>

    <!-- ‚òÅÔ∏è ÿ•ÿ∂ÿßŸÅÿ© ÿ®Ÿäÿ¶ÿ© AWS -->
    <div class="relative border border-emerald-800/60 rounded-2xl shadow-[0_0_35px_rgba(0,255,150,0.15)] p-8 
                bg-gradient-to-br from-gray-900/80 via-emerald-950/80 to-black/80 backdrop-blur-xl overflow-hidden fade-up">
        <div class="absolute inset-0 bg-gradient-to-tr from-emerald-700/20 via-transparent to-transparent blur-2xl"></div>
        <div class="relative z-10">
            <h2 class="text-3xl font-extrabold text-white mb-3 flex items-center gap-3 tracking-wide">
                <span class="text-emerald-400 drop-shadow-[0_0_6px_rgba(0,255,150,0.7)]">‚òÅÔ∏è</span>
                Add AWS Environment
            </h2>
            <div class="w-52 h-1.5 bg-gradient-to-r from-emerald-500 via-green-400 to-teal-500 rounded-full mb-8 shadow-[0_0_15px_rgba(0,255,150,0.5)]"></div>

            <p class="text-gray-400 mb-8">
                Configure a new AWS account for automated security auditing using 
                <span class="text-emerald-300 font-semibold">Prowler</span>. Credentials are stored securely on the server.
            </p>

            <form method="post" class="space-y-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Environment Name</label>
                        <input type="text" name="name" required 
                            class="w-full bg-gray-900/80 border border-emerald-700/60 rounded-xl p-3 text-white placeholder-gray-500 
                                   focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 transition" placeholder="e.g., Production Account">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Access Key ID</label>
                        <input type="text" name="access_key_id" required 
                            class="w-full bg-gray-900/80 border border-emerald-700/60 rounded-xl p-3 text-white placeholder-gray-500 
                                   focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 transition" placeholder="AKIA...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Secret Access Key</label>
                        <input type="password" name="secret_access_key" required 
                            class="w-full bg-gray-900/80 border border-emerald-700/60 rounded-xl p-3 text-white placeholder-gray-500 
                                   focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 transition">
                    </div>
                    <div class="flex items-end gap-3">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Default Region</label>
                            <input type="text" name="default_region" value="us-east-1" required 
                                class="w-full bg-gray-900/80 border border-emerald-700/60 rounded-xl p-3 text-white 
                                       focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 transition">
                        </div>
                        <button type="submit"
                            class="bg-gradient-to-r from-emerald-600 via-green-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 
                                   text-white font-semibold py-3 px-6 rounded-xl shadow-lg shadow-emerald-900/40 transform hover:scale-[1.05] active:scale-95 transition">
                            ‚ûï
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- üìã ÿßŸÑÿ®Ÿäÿ¶ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© -->
    <div class="relative border border-emerald-900/50 rounded-2xl p-6 bg-gray-900/70 backdrop-blur-xl 
                shadow-[0_0_25px_rgba(0,255,150,0.15)] fade-up">
        <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <span class="text-emerald-400">üìã</span> Configured Environments
        </h3>
        <div class="overflow-hidden border border-gray-800/70 rounded-xl backdrop-blur-sm">
            <table class="w-full text-sm text-left text-gray-300">
                <thead class="bg-gray-800/90 text-xs text-gray-400 uppercase tracking-wider">
                    <tr class="divide-x divide-gray-700">
                        <th class="px-5 py-3">Environment Name</th>
                        <th class="px-5 py-3">Default Region</th>
                        <th class="px-5 py-3">Last Scanned</th>
                        <th class="px-5 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800/70">
                    {% for env in environments %}
                    <tr class="hover:bg-gray-800/60 hover:shadow-[0_0_10px_rgba(0,255,150,0.25)] transition">
                        <td class="px-5 py-3 text-emerald-300 font-semibold">{{ env.name }}</td>
                        <td class="px-5 py-3 font-mono">{{ env.default_region }}</td>
                        <td class="px-5 py-3 text-gray-400">{{ env.scans.first.created_at|date:"Y-m-d H:i"|default:"Never" }}</td>
                        <td class="px-5 py-3 text-center">
                            <form method="post" action="{% url 'start_cloud_scan' env.id %}">
                                {% csrf_token %}
                                <button type="submit"
                                    class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-500 hover:to-green-500 
                                           text-white text-xs font-bold py-1.5 px-4 rounded-lg shadow hover:shadow-green-500/30 transition">
                                    Start Audit
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-8 text-gray-600 italic">No AWS environments configured yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- üß© ÿ¢ÿÆÿ± ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ≠ -->
    <div class="relative border border-emerald-900/50 rounded-2xl p-6 bg-gray-900/70 backdrop-blur-xl 
                shadow-[0_0_25px_rgba(0,255,150,0.15)] fade-up">
        <h3 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
            <span class="text-emerald-400">üìä</span> Recent Cloud Scans
        </h3>
        <div class="overflow-hidden border border-gray-800/70 rounded-xl backdrop-blur-sm">
            <table class="w-full text-sm text-left text-gray-300">
                <thead class="bg-gray-800/90 text-xs text-gray-400 uppercase tracking-wider">
                    <tr class="divide-x divide-gray-700">
                        <th class="px-5 py-3">Environment</th>
                        <th class="px-5 py-3">Status</th>
                        <th class="px-5 py-3">Scan Date</th>
                        <th class="px-5 py-3 text-center">Findings</th>
                        <th class="px-5 py-3 text-center">Report</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800/70">
                    {% for scan in scans %}
                    <tr class="hover:bg-gray-800/60 hover:shadow-[0_0_10px_rgba(0,255,150,0.25)] transition">
                        <td class="px-5 py-3 text-emerald-300 font-semibold">{{ scan.environment.name }}</td>
                        <td class="px-5 py-3">
                            <span class="font-semibold px-2.5 py-1 rounded-full text-xs
                                {% if scan.status == 'COMPLETED' %} bg-emerald-500/20 text-emerald-300
                                {% elif scan.status == 'ANALYZING' %} bg-amber-500/20 text-amber-300 animate-pulse
                                {% elif scan.status == 'FAILED' %} bg-rose-500/20 text-rose-300
                                {% else %} bg-gray-600/40 text-gray-400 {% endif %}">
                                {{ scan.get_status_display }}
                            </span>
                        </td>
                        <td class="px-5 py-3 text-gray-400">{{ scan.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="px-5 py-3 text-center font-mono">
                            {% if scan.status == 'COMPLETED' %}{{ scan.findings.count }}{% else %}-{% endif %}
                        </td>
                        <td class="px-5 py-3 text-center">
                            {% if scan.status == 'COMPLETED' %}
                                <a href="{% url 'cloud_scan_detail' scan.id %}" class="text-emerald-400 hover:text-emerald-300 hover:underline text-xs font-semibold">
                                    View Report
                                </a>
                            {% else %}
                                <span class="text-gray-600 text-xs">Not Available</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center py-8 text-gray-600 italic">No scans have been run yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ‚ú® ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑÿ∏ŸáŸàÿ± -->
<script>
const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
}, { threshold: 0.15 });
document.querySelectorAll('.fade-up').forEach(el => {
    el.classList.add('opacity-0','translate-y-6','transition-all','duration-1000');
    observer.observe(el);
});
document.head.insertAdjacentHTML("beforeend", "<style>.visible{opacity:1!important;transform:translateY(0)!important}</style>");
</script>

<!-- üéûÔ∏è ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ±ŸÇŸÖŸäÿ© ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉÿ© (Matrix Rain + Waves + Particles) -->
<script>
const rainCanvas = document.getElementById('matrixRain');
const ctxRain = rainCanvas.getContext('2d');
const wavesCanvas = document.getElementById('cyberWaves');
const ctxWaves = wavesCanvas.getContext('2d');

let width, height, t = 0;
let columns, drops = [];
let particles = [];

function resizeCanvas() {
  width = rainCanvas.width = wavesCanvas.width = window.innerWidth;
  height = rainCanvas.height = wavesCanvas.height = window.innerHeight;
  columns = Math.floor(width / 20);
  drops = Array(columns).fill(1);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawMatrixRain() {
  ctxRain.fillStyle = 'rgba(0,0,0,0.08)';
  ctxRain.fillRect(0, 0, width, height);
  ctxRain.fillStyle = 'rgba(0,255,150,0.35)';
  ctxRain.font = '15px monospace';
  for (let i = 0; i < drops.length; i++) {
    const text = Math.random() > 0.5 ? '0' : '1';
    ctxRain.fillText(text, i * 20, drops[i] * 20);
    if (drops[i] * 20 > height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  }
}

function drawCyberWaves() {
  ctxWaves.clearRect(0, 0, width, height);
  ctxWaves.strokeStyle = 'rgba(0,255,150,0.2)';
  ctxWaves.lineWidth = 1.3;
  for (let i = 0; i < 3; i++) {
    ctxWaves.beginPath();
    for (let x = 0; x < width; x++) {
      const y = height / 2 + Math.sin(x * 0.003 + t / 20 + i) * 35 + i * 30;
      ctxWaves.lineTo(x, y);
    }
    ctxWaves.stroke();
  }

  ctxWaves.fillStyle = 'rgba(0,255,150,0.1)';
  particles.forEach(p => {
    ctxWaves.beginPath();
    ctxWaves.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctxWaves.fill();
    p.y += p.speed;
    if (p.y > height) p.y = -10;
  });
  t += 0.5;
}

for (let i = 0; i < 60; i++) {
  particles.push({ x: Math.random() * width, y: Math.random() * height, size: Math.random() * 2 + 0.5, speed: Math.random() * 0.5 + 0.2 });
}

function animate() {
  drawMatrixRain();
  drawCyberWaves();
  requestAnimationFrame(animate);
}
animate();
</script>
{% endblock %}
